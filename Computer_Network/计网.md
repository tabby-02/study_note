# 第1章 计算机网络和因特网

## **1** 什么是因特网

### 1.1具体构成描述

1.计算设备(主机(终端系统),服务器)

2.通信链路(光纤、同轴电缆、无线电、卫星)

3.中转设备(路由器和交换机)

### 1.2 服务描述

分布式应用程序:在端系统上运行，彼此可以通信。

应用程序仅运行在终端系统上，不运行在网络核心的分组交换机中，因此**因特网**是**为应用程序提供服务**的基础设施。 

由终端系统提供应用程序编程接口(API) 

### 1.3 什么是协议

由某些设备的硬件或软件执行。

一个协议定义了在两个或多个通信实体之间交换的**报文格式和次序**，以及报文**发送**和/或**接收**一条报文或其他事件**所采取的动作**。

**协议三要素**：**语义，语法，时序**

## 2 网络边缘

### 网络划分为两大部分： 

**网络边缘**（资源子网） 

  外围部件、主机（客户、服务器）  网络应用
**网络核心**（通信子网） 

 **路由器** **通信链路** 网络的网络

### 2.1 接入网

接入网：将**端系统**连接到其**边缘路由器**的物理链路。

<img src="Snipaste_2024-06-11_09-26-27.png" style="zoom:60%;" /> 

三种接入网

#### 1、家庭接入（DSL、电缆、FTTH、拨号和卫星）

<img src="Snipaste_2024-06-11_09-44-38.png" style="zoom:60%;" /> 

##### (1).数字用户线(DSL)

使用已有的**电话线**传送信号

DSL采用<u>***频分复用技术***</u>(可以同时打电话和上网的原因)

##### (2).混合光纤同轴电缆(HFC)

**同轴电缆**和**光纤**混合接入

采用特殊的电缆调制解调器
划分为两个信道
共享广播媒体(**频分复用技术**)

##### (3).光纤到户技术(FTTH)

##### (4).卫星链路接入

#### 2、企业（和家庭）接入

<img src="Snipaste_2024-06-11_09-44-48.png" style="zoom:60%;" /> 

#### 3、广域无线接入(移动接入)

### 2.2 物理媒体

#### 1、双绞铜线(如电话线)

两根绝缘的铜线螺旋形式扭合在一起。**减少对邻近双绞线的电气干扰**。

双绞线**电缆**：多对(4对)双绞线捆扎成一根电缆，并在外面覆盖上防护层

#### 2、 同轴电缆(电缆)

套在一起的两个同心铜导体。

 **内导体**传递**数据**。
 **外导体**用作地线及**屏蔽干扰**。

抗干扰能力强、数据率高。

#### 3、光纤

#### 4、 陆地无线电信道

无线LAN，WAP、3G、4G技术

#### 5、卫星无线电信道

## 3 网络核心

网络内部：连接端系统的**分组交换机**和**链路**形成的网状网络

数据如何通过网络传送：分组交换

### 3.1分组交换(不需要资源预留)

1.**不需要资源预留**；

2.按需使用资源，可能要排队等待：同时有其它分组发送。如，因特网。

定义：主机将应用层消息分割为若干**分组/小包(packets）**，通过每个**路由器逐跳**的转发分组，每个分组以链路的**最大传输速率传输**

#### 存储转发机制 

#### 两个关键的网络核心功能

**路由**(routing): 确定分组从源-目的主机的路径

**转发**(forwarding): 将分组从路由器的输入端口转到适当的路由器的输出端口（每个分组都会包含接收终端的IP地址，路由器根据IP地址在自己的<u>转发表</u>中查找这个IP地址对应的输出链路）

### 3.2 电路交换(预留端到端资源)

1.**预留端到端资源**

2.发送方以**恒定速率**向接收方传送数据。如，电话网络

定义：通信双方必须先建立一个**专用的连接**（电路），一直维持，直到通信结束。如，电话网络。

缺点：

1.**效率较低**：静默期（无数据传输）专用电路空闲，网络资源被浪费

2.创建端到端电路及预留端到端带宽的过程复杂

#### 频分多路复用FDM

按频率划分若干频段，**每个频段**专用于一个连接

<img src="Snipaste_2024-06-11_10-29-58.png" style="zoom:60%;" /> 

#### 时分多路复用TDM

时间划分为固定区间的帧，每帧再划分为固定数量的时隙，**每个时隙**专用于一个连接

<img src="Snipaste_2024-06-11_10-30-02.png" style="zoom:60%;" /> 

### 3.3 几种交换技术对比

<img src="Snipaste_2024-06-11_10-34-27.png" style="zoom:60%;" /> 

### 3.4 网络的网络

终端系统通过**ISP**s(**因特网服务提供商**)与因特网相连，接入**服务提供商必须相互连接**，最终形成非常复杂的**网络的网络**—因特网

<img src="Snipaste_2024-06-11_10-44-50.png" style="zoom:60%;" /> 

## 4分组交换网中的时延、丢包和吞吐量

### 4.1四种时延：**节点处理时延**、**排队时延**、**传输时延**和**传播时延**

**节点处理时延**d<sub>proc</sub>：检测比特错误，确定输出链路

**排队时延**：在一段时间内，分组到达链路速率超过了链路的传输速率，分组将排队，在输出链路上等待传输；

**传输时延**d<sub>trans</sub>：发送需要的时间， *L*: 分组长度bits，*R*: 带宽(传输速率)bps，传输时延= **L/R**

**传播时延**d<sub>prop</sub>：将分组从传输链路的一端传输到另一端，d：物理链路长，s：光在真空中传播速度(传播速率)，传播时延=**d/s**

**丢包**：排队时如果缓存溢出，则会出现丢包

丢失的分组可以由**前一个节点重传**，也可以由**源终端系统重传**，或根据**不需要重传**

<img src="Snipaste_2024-06-11_10-38-24.png" style="zoom:60%;" /> 

**端到端时延**：发送**分组的长度**为**L**比特，将分组发送到接入链路的**传输速率**为**R**(bits/sec)，那么发送需要的时间为**L/R**，**端到端时延2L/R**

单个分组端到端时延(单个报文端到端时延)：d<sub>end-end</sub> =N(d<sub>proc</sub>+d<sub>trans</sub>+d<sub>prop</sub>)(N条链路，N-1个路由器)

多个分组连续发送端到段时延:d<sub>end-end</sub> =(N+n-1)(d<sub>trans</sub>+d<sub>proc</sub>)+Nd<sub>prop</sub>(N条链路，n个分组)

<img src="Snipaste_2024-06-11_11-44-29.png" style="zoom:60%;" /> 

<img src="\IMG20240229160649.jpg" style="zoom:15%;" /> 

#### Traceroute的原理

• 从源地址发出一个**UDP探测包**到目的地址，并将**TTL设置为1**； 
• 到达路由器时，将**TTL减1**； 
• 当**TTL变为0时**，包被丢弃，路由器**向源地址发回**一个ICMP超时通知,内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；
• 重复1～5，并**每次设置TTL加1**； 
• 直至目标地址收到探测数据包，并返回**端口不可达通知**

### 4.2吞吐量(Throughput)

吞吐量：在发送方和接收方之间**传输的比特数**（位/时间单位） (注意与带宽的区别-**发送方发送**分组的传输速率-**发送方和接收方之间**单位时间传输比特数)(单位都是bps)

即时吞吐量：在给定时间点的传输速率 

平均吞吐量：在较长时间段内的传输速率

## 5 协议层次及其服务模型

### 5.1 分层的体系结构

#### 1.网络协议为什么要进行分层？

 **使复杂系统简化**：将一个大而复杂系统划分为若干个明确、特定的部分，分别讨论研究。

 **易于维护、系统的更新**：某层功能变化，**不会影响系统其余部分**。

#### 2.分层的特点

 每个层次实现一个相对单一的服务

 每层自己执行一些动作来完成服务

 每层可以使用相邻下一层提供的服务

上层调用下层提供的服务，下层为上层提供服务

**服务定义**：各层通过其SAP向上层提供的一组功能

#### 3.TCP/IP协议栈

<img src="Snipaste_2024-06-11_11-56-21.png" style="zoom:60%;" /> 

5.应用层：支持**网络应用**（FTP, SMTP, HTTP，DNS）

4.运输层：完成**端到端的数据传输**（TCP, UDP）

3.网络层：**数据报**从源地址到目的地址的**路由**（IP, 路由协议(RIP,OSPF,BGF)，ICMP）

2.链路层：**相邻**网络元素间**数据传输**（Ethernet, 802.11 (WiFi), PPP）

1.物理层

**路由器**：实现**第一层到第三层**，能够实现IP协议；

**链路层交换机**：实现**第一层和第二层**，能够识别第二层地址，如以太网地址。

**主机**：实现**所有5个层次**

### 5.2 封装

源主机：由高层向低层逐层传递数据（封装）

<img src="Snipaste_2024-06-11_12-10-36.png" style="zoom:100%;" /> 

目的主机：由低层向高层逐层传递（解封装）

如果报文很长，传输时，可先**分成多个报文段**，每个报文段在网络层再**分成多个数据报**。

## 6 面对攻击的网络

### 1.经因特网将有害程序放入你的计算机中

恶意代码：**病毒**，**蠕虫**

间谍软件

### 2.攻击服务器和基础设施

**Denial of Service (DoS):** 攻击者使资源(server/bandwidth)对于合法的流量不可用，通过使用虚假的流量来耗费资源

### 3.嗅探("Sniff)分组

### 4.伪装成你信任的人

IP哄骗

# 第2章 应用层

## 1 应用层协议原理

### 1.1 网络应用程序体系结构

两种体系结构

#### 1.client-server(**C/S**, B/S)  

(1)服务器(server): 

 **保持开机**状态 **固定的IP地址** 可以采用具有扩展性的数据中心

(2)客户端(client):

 主动与服务器进行通信 可以间断性连接 可以采用动态IP地址 客户端进程之间**相互不通信**

#### 2.peer-to-peer (**P2P**)

服务器**不需要总是开机状态**，任意的终端系统之间**可以直接通信**，对等节点可以间歇性互连和<u>改变IP</u>地址（管理非常复杂）

### 1.2 进程通信

**不同主机**上的**进程通信**可以采取**消息交换**

#### 1.套接字(socket)

进程发送/接收消息给/从它的套接字-------------(类似门，进出都通过它)

#### 2.进程寻址

**标识符**(identifier)包括与进程运行主机关联的**IP地址**和**端口号**(port numbers).

**IP地址**:唯一标识<u>*主机*</u>  **端口号**：唯一标识<u>*进程*</u>

### 1.3 可供应用程序使用的运输服务

<img src="Snipaste_2024-06-11_13-46-49.png" style="zoom:60%;" /> 

### 1.4 应用层协议

交换**消息的类型**(e.g., request, response)，消息**语法**，消息**语义**，**规则**(在什么时候以及如何发送&响应消息)

## 2 Web和HTTP(使用TCP,port:80)

HTTP: 超文本传输协议

**网页**可以包括多个对象

**对象**可以是 HTML file, JPEG image, Java applet, audio file,…

### 2.1 HTTP概况

**使用TCP**：客户端进程发起TCP连接请求(通过创建socket), port 80

HTTP是**无状态**的：服务器**不维护历史的客户请求信息**

### 2.2 HTTP 连接

<img src="Snipaste_2024-06-11_17-45-14.png" style="zoom:60%;" /> 

**1.非持续HTTP连接**：通过TCP连接**最多发送一个对象**，然后关闭TCP连接

每个对象要求2个RTTs，1个RTT用于建立TCP连接，1个RTT用于HTTP请求，响应时间 = 2RTT+ file transmission time

非持续无并行：**N*2RTT**+N file transmission time)

非持续n并行：**(2RTT)+(N-1)/n*(2RTT)**+N file transmission time

HTML文件用时+其他对象用时

**2.持续HTTP连接**：多个对象可以基于一个TCP连接发送

非流水线方式：客户机只能在前一个响应接收到之后才能发出新的请求。

流水线方式：客户机可一个接一个连续产生请求

持续流水：1RTT+1RTT+1RTT+N file transmission time=**3RTT**+N file transmission time

TCP(1)+HTML(1)+其他对象(1)

持续非流水：**(1+N)RTT**+N file transmission time

TCP(1)+所有对象(N)

### 2.3 HTTP报文格式

#### 1.请求：方法+URL路径+协议版本

<img src="Snipaste_2024-06-11_14-14-00.png" style="zoom:80%;" /> 

**HTTP/1.0**:  GET  POST  HEAD

**HTTP/1.1**:  GET, POST, HEAD  PUT  DELETE

**POST**：输入**通过(entity body)**上传到服务器

**GET**(URL方法)： 输入**通过**请求命令行的**URL字段**上传

**HEAD**：请求返回对象响应报文**首部**

**PUT**：将entity body中的**文件上传**到URL字段指定的位置

**DELETE**：**删除**URL字段中指定的**文件**

#### 2.响应：协议版本+状态码+短语

<img src="Snipaste_2024-06-11_14-15-35.png" style="zoom:80%;" /> 

**200 OK**

**301 Moved Permanently (永久的重定向)**

**400 Bad Request**

**404 Not Found**

**505 HTTP Version Not Supported**

### 2.4 用户与服务器的交互：cookies

四个组件：

1) HTTP**响应消息**中的一个**cookie首部行**

2) 下一个HTTP**请求消息**中的一个**cookie首部行**

3) 保存在用户**主机上的cookie文件**，由用户的**浏览器**管理

4) Web站点的后台**数据库**

应用场景：认证，购物车，推荐，用户会话状态

### 2.5 web 缓存(代理服务器)

目标: 不需要原始服务器就可以满足用户需求。

如果请求对象存在于缓存服务器：缓存服务器直接返回对象给客户。
如果请求对象不在缓存服务器中：缓存服务器向原始服务器请求，然后返回对象给客户。

代理服务器同时扮演客户端和服务端。

作用：**减少**对于客户端请求的**响应时间**。**减少**原始服务器接入链路的**流量**。

### 2.6 条件GET

条件GET：允许缓存服务器证实它的**对象是最新的**

具体方法:

• (C)发送包含上次更新的时间

• (S)如果没有发生修改(比对接收的和本地的上次更新时间是否相同)，则返回一个空数据的响应报文（304 Not Modified）

• (S)如果发生了修改，则返回一个最新的数据

## FTP: 文件传输协议(21/20)（不要求）

FTP 服务器：端口号(21/20)

## 3 因特网中的电子邮件

 <img src="Snipaste_2024-06-11_16-01-37.png" style="zoom:60%;" /> 

### 3.1 SMTP(使用TCP,port:25)

**<u>*服务器间使用，代理发邮件使用*</u>**

<img src="Snipaste_2024-06-11_15-49-31.png" style="zoom:60%;" /> <img src="Snipaste_2024-06-11_17-42-01.png" style="zoom:60%;" /> 

 HTTP: pull（拉模式）

 SMTP: push（推模式）

HTTP: **一个对象**对应**一个报文**
SMTP: **多个对象**封装在**一个报文**中

#### MIME（属于SMTP）

对于非ASCII字符文本，为了能够使用SMTP进行传输，引入了MIME协议

### 3.2 POP3(使用TCP,port:110)/IMAP

**<u>*代理收邮件使用*</u>**

简单、功能有限：在用户代理打开了一个到邮件服务器(服务器)端口110上的TCP连接后，开始工作。

### 3.3 HTTP

**<u>*代理收、发邮件使用*</u>**

## 4 DNS：因特网的目录服务(使用UDP,port:53)

### 4.1 DNS提供的服务

#### DNS作用

 **主机名到IP地址的转换**

 主机**别名**查询 

 **负载均衡** 

#### 为什么不使用单一的DNS服务器

 单一点失效

 流量负担

 远程的集中式数据库

 维护开销大

### 4.2 分布式、层次数据库

 **根服务器**：有13个，维护**顶级域名服务器**的**IP地址**
 **顶级域服务器**（TLD）：维护**顶级域名**的**IP地址**。顶级域名：com、org、net、edu、gov、jp、ca、cn
 **权威DNS服务器**：由组织机构维护的自己提供的服务器的域名到IP地址映射的DNS服务器。(每个学校，企业)
• 本地DNS服务器(默认DNS服务器)： 

### 4.3 DNS域名解析过程

#### 1.迭代查询

本地DNS服务器代表查询主机发送查询请求。

<img src="Snipaste_2024-06-11_16-27-01.png" style="zoom:60%;" /> 

#### 2.递归查询

以DNS客户端自己的名义发出查询请求，来获得IP地址映射信息。

<img src="Snipaste_2024-06-11_16-27-24.png" style="zoom:60%;" /> 

### 4.4 DNS 缓存

当某DNS服务器接收一个DNS回答时，它能将映射**缓存在本地存储器**中。

 **当TTL时间超时**，缓存的映射条目会**超时删除**（通常为2天）
 **顶级域服务器**(TLD)通常**会被本地**域名服务器**缓存**
• 从而**<u>*减少根域名服务器被访问的次数*</u>**

### 4.5 DNS记录和报文

#### 1.资源记录(RR)

RR format: (name, value, type, TTL(生存时间))

1)type=A（主机名/IP地址）

（**主机名**，**IP地址**，A）

 例子：(www.uestc.edu.cn, 1.2.3.4, A)

2)type=NS(域名/IP地址)

（**域名**，**DNS服务器名**，NS）

 例子：(uestc.edu.cn, dns.uestc.edu.cn, NS)

3)type=CNAME (别名/规范名)

（别名，规范名，CNAME）

4)type=MX(别名/规范名)邮件服务器

（邮件服务器名，规范名，MX）

<img src="Snipaste_2024-06-11_16-21-25.png" style="zoom:80%;" /> 

<img src="Snipaste_2024-06-11_16-55-50.png" style="zoom:80%;" /> 

#### 2.插入记录到DNS

<img src="Snipaste_2024-06-11_17-01-47.png" style="zoom:80%;" /> 

TLD：**DNS服务器**的**A记录**，**主机到DNS服务器**的映射**NS记录**。

权威：**主机**的**A记录**。

#### 3.报文（不考）

## 5 P2P文件分发（不考）

## 6 视频流和内容分发网（CDN）

### 6.1 HTTP流和DASH

1.**HTTP流**：用户通过请求视频URL对应文件，服务器发送这个文件，客户**将收到的视频数据在应用缓存中缓存，如果缓存的数据量达到阈值，播放器就可以开始播放。**

优点：用户可以在**接收数据的同时播放视频**，不用等到所有数据完全接收

缺点：用户收到的视频流是**相同的编码速率**，不能根据用户的带宽差异，给出不同的视频编码速率选择(质量)

2.**DASH**：将视频文件分为**多个块**，每个区块都以不同的速率存储、编码

服务器**告示文件**：为不同的块提供URL

客户端根据当前的可用带宽智能决策

### 6.2 内容分发网络（CDN）

将**视频的多份拷贝**存储在地理上**分散的不同站点**来提供服务，将每个用户请求定位到能为用户提供最好服务的位置

#### 1.服务器放置原则

1）**深入**：目标是**靠近终端用户**，通过减少终端用户与CDN集群之间链路和路由器的数量，从而改善用户感受(减小时延，提升吞吐量)。

**高度分布式**设计，维护和管理集群困难。

2）**邀请做客**：在少量**关键位置**(例如IXP)，建造大集群，邀请到ISP做客。

只产生较低的维护和管理开销。

## 7 套接字编程：生成网络应用

socket: 位于应用进程和端到端传输协议之间的门

### 7.1 UDP套接字编程

UDP: 在客户端和服务器之间不建立连接

 发送数据前**不“握手”**

 **发送方**明确地**粘贴IP目的地址和目的端口号给每个发送的分组**

 **接收方**从收到的分组中**抽取发送方IP地址**

<img src="Snipaste_2024-06-11_18-08-33.png" style="zoom:60%;" /> 

### 7.2 TCP套接字编程

客户端必须联系服务器

 服务器进程**必须首先运行**

 服务器必须**创建套接字**(socket)**用于**欢迎客户端进程的联系(**侦听**套接字)

 当收到客户端进程的联系，服务器TCP为服务器进程**创建新的套接字**，经过“三次握手” ，建立一个TCP连接

客户端进程联系服务器：

 **创建TCP套接字**，**指定服务器的IP地址和端口号**

<img src="Snipaste_2024-06-11_18-16-13.png" style="zoom:80%;" /> 

# 第3章 运输层

## 1 概述和运输服务

网络层: **主机间**的**逻辑**通信.
运输层: **进程间**的**逻辑**通信.

因特网运输层协议:

可靠的、按序的交付 :TCP

不可靠、不按序交付: UDP

## 2 多路复用/多路分解

### 2.1分解工作过程

主机<u>接收IP数据报</u>，主机使用IP地址 &端口号将**段**<u>定向到适当的套接字</u>

<img src="Snipaste_2024-06-11_19-44-58.png" style="zoom:150%;" /> 

### 2.2无连接分解(UDP)

 UDP套接字由二元组标识 :**(目的IP地址, 目的端口号)**

具有**不同源**IP地址和/或源端口号，但是具有**相同目的**IP地址和相同目的端口号的IP数据报将定向到**相同的套接字**

### 2.3面向连接的多路分解(TCP)

 TCP套接字标识是由四元组标识:**(源IP地址, 源端口号，目的IP地址, 目的端口号)**

具有**不同源**IP地址和/或源端口号，但是具有**相同目的**IP地址和相同目的端口号的IP数据报将定向到**不同的套接字**（为每个连接客户端进程创建不同的套接字）

## 3 UDP: 用户数据报协议

“尽力而为”服务，UDP段可能：

 **丢包**   对应用程序交付**失序**

为何要有 UDP协议?

 无连接创建(**减少了时延**)
 **简单**：在发送方、接收方无连接状态
 **段首部小**
 无拥塞控制: UDP能够**尽可能快地传输**

### 3.1 UDP报文段结构

<img src="Snipaste_2024-06-11_19-58-21.png" style="zoom:60%;" /> 

### 3.2 UDP校验和

**经UDP的可靠传输** : **在应用层增加可靠性**（**验证校验和**）

发送方：将段内容处理成16比特序列(每16比特一组)，计算校验和，放入UDP报文段对应位置

接收方：计算接收到的段的校验和是否等于接收到的校验和

<img src="Snipaste_2024-06-11_20-02-15.png" style="zoom:80%;" /> 

## 4 可靠数据传输的原则

### 4.1 rdt1.0

简单场景：经可靠信道传输-----无比特差错，无分组丢失

<img src="Snipaste_2024-06-11_20-38-15.png" style="zoom:60%;" /> 

### 4.2   rdt2.x

较复杂场景：经有比特差错的信道传输-----分组中的某些比特可能反转，无分组丢失

机制设计：**检验和**机制检查差错，接收方通知发送方**重传**(ACK,NAK)

rdt2.0:

rdt2.1:处理冗余: 发送方对每个分组增加**序列号**

<img src="Snipaste_2024-06-11_21-29-15.png" style="zoom:60%;" /> 

<img src="Snipaste_2024-06-11_21-29-20.png" style="zoom:60%;" /> 

rdt2.2:仅使用ACK（回复时正确回复当次，错误回复上次(通知重传)）

### 4.3   rdt3.0

具有比特差错和丢包的信道-----分组中的某些比特可能反转，分组可能丢失

方法: 发送方等待ACK一段“合理的”时间，如在这段时间没有收到ACK则重传(timeout)

rdt3.0:多设置**计时器**，错误时不再重传，**只在超时时重传**

<img src="Snipaste_2024-06-11_21-02-48.png" style="zoom:80%;" /> 

<img src="Snipaste_2024-06-11_21-06-48.png" style="zoom:80%;" /> 

### 4.4 流水线协议

rdt3.0: 停等协议的运行**效率低下**

**流水线**: 发送方允许发送多个、“传输中的” ，还没有应答的报文段

**序号的范围必须增加**，发送方和/或接收方设有**缓冲**

#### 1）Go-Back-N（GBN）

分组首部需要**K比特序号**，只有**发送方有缓冲区(窗口)**

<img src="Snipaste_2024-06-11_21-53-14.png" style="zoom:60%;" /> 

**对失序的分组: 丢弃** (不缓存) -> 没有接收缓冲区!

<img src="Snipaste_2024-06-11_21-59-45.png" style="zoom:80%;" /> 

和rdt3.0较类似，只是发送方可以多发了，失序、冗余的判断变了点(**接收方对失序的会丢弃后面的所有**，但发送方对失序的会自动判断目前接收的回复的最大数字为基准(即便回复ACK丢失，发送方也能判断到接收方成功收到了))

#### 2）选择性重传（SR）

<img src="Snipaste_2024-06-12_10-50-21.png" style="zoom:60%;" /> 

<img src="Snipaste_2024-06-12_10-53-14.png" style="zoom:80%;" /> 

<img src="Snipaste_2024-06-12_10-55-49.png" style="zoom:60%;" /> 

 注：**窗口长度小于等于序号空间的一半** ，否则可能接收方会将冗余的序号当作了新的序号接收

例：序号长8，窗口长就要<=4

## 5 TCP的数据可靠传输机制

### 5.1 TCP 报文段结构

<img src="Snipaste_2024-06-12_11-06-43.png" style="zoom:80%;" /> 

### 5.2 TCP机制

在什么情况下，启动重传(判断数据报丢失)：
 **定时器超时**，则认为对应的数据报丢失，**立即重传**；
 **收到3个相同的ACK(n)确认**，则认为对应的数据报丢失，**立即重传**；

TCP的发送方**只维护一个定时器**(timer)：**是最早的发送且还未确认的**

（与SR区别：TCP和SR都是两个缓冲区，但SR有**N**个定时器，TCP只有**一**个定时器：SR回复**当前确认号**(无累计确认机制)，TCP回复最大的**前面全部确认的确认号**(有累计确认机制)）

<img src="Snipaste_2024-06-12_11-18-43.png" style="zoom:80%;" /> <img src="Snipaste_2024-06-12_11-36-11.png" style="zoom:60%;" />

###  5.3 TCP定时器超时时间设置

当次误差RTT：**DevRTT** = (1-β)×DevRTT' + β×|SampleRTT-EstimatedRTT'|   ------------(β = 0.25)(DevRTT':上次的误差RTT)(EstimatedRTT':上次的估计RTT(不是这次))

当次估计RTT：**EstimatedRTT** = (1- α)×EstimatedRTT' + α×SampleRTT   ------------(α **=** 0.125)(EstimatedRTT':上次的估计RTT)

超时时间：**TimeoutInterval** = EstimatedRTT + 4×DevRTT

简记：误差=0.75上次误差+0.25|样本-上次估计|

估计=0.875上次估计+0.125样本

### 5.4 TCP流水线机制(总结)

TCP采用了一种GBN和SR的混合机制
 **累计确认**
 **单个定时器**
 将失序达到的报文段**缓存**
 每次重传只发送一个报文段(无论是定时器超时，还是收到3个重复ACK)

### 5.5 TCP概述

**点到点**

**可靠、有序的字节流**

**流水线**

**发送和接收缓冲区**

**全双工数据**： 同一连接上的<u>双向数据流</u>  <u>MSS: 最大报文段长度</u>  <u>MTU:最大传输单元</u>

MSS(最大报文段1460**字节**)+TCP和IP头部的长度（40字节=20+20）= MTU(最大传输单元1500字节)(不包含链路层头部)

**面向连接**

**流量控制**： 发送方不能<u>淹没</u>接收方

**拥塞控制**： 抑止发送方速率来防止<u>过分占用网络资源</u>

### 5.6 TCP 流量控制(接收方溢出)

发送方不能发送太多、太快的数据让**接收方**缓冲区溢出

方法：接收方在报文段接收窗口字段中**通告其接收缓冲区的剩余空间**
 发送方要**限制**未确认的数据不超过RcvWindow(限制发送)
 保证接收缓冲区不溢出

TCP的**rwnd**表示接收窗口指针。它表示接收缓冲区还可以接收多少字节的数据

### 5.7 TCP连接管理

#### 1.建立连接---三次握手

**步骤 1**: 客户机向服务器发送 TCP <u>***SYN***</u>报文段

 指定初始序号（随机产生） 没有数据

**步骤 2**: 服务器收到SYN报文段, 用**<u>*SYNACK*</u>**报文段回复

 服务器为该连接分配缓冲区和变量 指定服务器初始序号

**步骤 3**: 客户机接收到 SYNACK, 用***<u>ACK</u>***报文段回复,可能包含**<u>*数据*</u>**

<img src="Snipaste_2024-06-12_13-32-29.png" style="zoom:60%;" /> 

不使用二次握手的标准回答 （为什么使用三次握手）
 三次握手的第2步中，**服务器**端将自己选择的**初始序号**发送给客户端，因此客户端**需要**在**第3步**中**向服务器确认此序号**，可见二次握手是不够的； （为什么不<3）
 三次握手**已经达到建立可靠连接的目的**，更多次的握手就是多次重复确认，从效率来说已无必要。（为什么不>3）

<img src="Snipaste_2024-06-12_13-46-04.png" style="zoom:60%;" /> <img src="Snipaste_2024-06-12_13-47-37.png" style="zoom:60%;" /> 

#### 2.关闭连接---四次挥手

**任何一方都可以发送消息主动关闭连接**

步骤 1: 客户机向服务器发送TCP **<u>*FIN*</u>**控制报文段

步骤 2: 服务器收到FIN，用**<u>*ACK*</u>**回答。关闭连接，发送**<u>*FIN*</u>**

步骤 3: 客户机收到FIN, 用**<u>*ACK*</u>**回答

 进入 “超时等待” – 将对接收到的FIN进行确认

步骤 4: 服务器接收ACK，**<u>*连接关闭*</u>**

<img src="Snipaste_2024-06-12_13-50-06.png" style="zoom:80%;" /> 

### 5.8 拥塞控制原理（不考）

### 5.9 拥塞控制方法（路由器溢出、排队）

**网络**来不及处理： 丢包 (**路由器**缓冲区溢出) 长时延 (**路由器**缓冲区中排队)

#### 1.端到端的拥塞控制（TCP所采用）

 不能从网络得到明确的反馈 (**没有网络辅助**)

 从端系统根据观察到的**时延和丢失**现象推断出拥塞

:one:**慢启动状态**(指数)

在连接开始时, 拥塞窗口值cwnd = **1 MSS**(报文段长)，后以**指数**倍增加速率(**每收到1个ack确认**，cwnd增加1个**MSS**)，直到第一个丢失事件发生

:two:**拥塞避免状态**(CA)(线性)

拥塞窗口cwnd达到**ssthresh**(cwnd'/2)值后，后以**线性**增加速率(cwnd在**每个RTT**，值增加一个**MSS**)

:three:**快速恢复状态**

收到**三个冗余**确认后，<u>*ssthresh设置*</u>为**cwnd/2**，且cwnd设置为**ssthresh+3*MSS**

 如果收到一个**重复的ACK**，cwnd = cwnd + 1 MSS（**+1后维持快速恢复状态**）--线性
 当收到一个**新的ACK**（即期望报文的ACK），TCP在降低拥塞控制窗口(cwnd = ssthresh)后**进入拥塞避免状态**；--线性
 当发生**超时事件**，说明已经发生拥塞，进入**慢启动状态**。--指数

:three:**回到慢启动状态**

当**超时**发生时（此时可以是拥塞避免或者快速恢复）， <u>*ssthresh设置*</u>为**cwnd/2**，并且cwnd设置为**1 MSS**.

<img src="Snipaste_2024-06-12_14-34-51.png" style="zoom:80%;" /> 

<img src="Snipaste_2024-06-12_14-40-11.png" style="zoom:80%;" /> 

#### 2.网络辅助的拥塞控制（没讲）

路由器为端系统提供反馈

### 5.10 TCP吞吐量

定义：如果窗口长度为 W，吞吐量是 W/RTT（**每RTT可以发送W字节的数据**）

### 5.11 TCP公平

:one:公平目标: 如果K个TCP会话共享带宽为R的链路瓶颈, 每个会话应有R/K的平均链路速率

:two:为什么TCP能保证公平性?

两个竞争会话:

 随着吞吐量的增加，按照斜率1**加性增加**(拥塞避免)

 等比例地**乘性降低**吞吐量(三个冗余)

# 第4章 网络层：数据平面 

## 1 网络层概述

### 1.0 概述

#### 1 网络层与运输层

网络层: **主机间**的**逻辑**通信.
运输层: **进程间**的**逻辑**通信.

#### 2 数据平面和控制平面

:one:**数据平面**

本地、每个**路由器的功能**

将数据报从路由器的输入端口**转发**到路由器的输出端口

转发功能

:two:**控制平面**

网络范围的**逻辑**

确定数据报从发送主机到接收主机的端到端**路径**上通过的路由器是哪些

两个**控制平面的方案**：传统路由算法，在路由器中实现；软件定义网络(SDN)，在远程的服务器上实现。

#### 3 路由器和链路层交换机

 链路层交换机：根据**链路层字段值**作转发决定的分组交换机。

 路由器：根据**网络层字段值**作转发决定的分组交换机。

#### 4 因特网网络层不建立连接

**因特网的网络层<u>*不*</u>建立连接**！路由器上不需要维护状态。

其他的网络模型有些会建立网络层连接：ATM、帧中继、MPLS(路由器之间相互握手，建立连接状态)

### 1.1 网络服务模型

:yum:**ATM**网络体系是基于**虚电路**网络，在发送数据前**需要**在网络层**建立连接**(路径上的路由器之间)；(确保按序时延、有界时延和确保最小带宽)

:yum:**因特网**是基于**数据报**网络，在发送数据前**不需要**在网络层**建立连接**。(**尽力而为**，定时不能被保证，分组到达顺序不保证，不保证交付)

:arrow_forward:任何网络中的网络层只提供两种服务之一，不会同时提供

:one:虚电路网络：提供连接服务。

不要求

:two: 数据报网络：提供无连接服务。

在网络层无呼叫的过程。
路由器： 不需要维护端到端连接的状态。
没有网络等级的“连接”的概念。
使用目的主机的地址进行分组转发。

## 2  路由器工作原理

**转发方法**：路由器根据到达**分组的首部值**在**转发表中查询**，找到相应的输出链路接口，并将分组转发出去。

路由器的**两个核心功能**：

:one:**路由**：运行路由算法/协议(RIP, OSPF, BGP)

:two:**转发**：将分组从路由器的输入链路传送到正确的输出链路。

### 2.1 输入端口处理和输出端口处理

#### 1 输入端口处理

<img src="Snipaste_2024-06-12_16-09-53.png" style="zoom:80%;" /> 

<img src="Snipaste_2024-06-12_16-10-41.png" style="zoom:60%;" /> 

#### 2 输出端口处理

<img src="Snipaste_2024-06-12_16-39-45.png" style="zoom:80%;" /> 

### 2.2 基于目的IP地址的转发

根据分组的目的IP地址在**转发表中查询**，找到相应的输出链路接口，并将分组转发出去

**转发表**：每台路由器维护一张路由表，**目的地址**与**链路接口**的映射表。（**每个路由器一个转发表**）

:one:**最长前缀匹配规则**

即在**存在多个匹配时**，向与**最长前缀匹配的**链路接口转发分组。

<img src="Snipaste_2024-06-12_16-19-15.png" style="zoom:80%;" /> 

:anger:例题

<img src="Snipaste_2024-06-12_16-54-54.png" style="zoom:50%;" /> <img src="Snipaste_2024-06-12_16-55-06.png" style="zoom:50%;" /> 

:two:**分布式交换**：

• 选路处理器计算转发表，给**每个输入端口**存放一份**转发表拷贝**。

• 在每个输入端口**本地**做出**交换决策**，**无须激活中央选路处理器**。

• 优点：可避免在路由器中某个单点产生转发处理瓶颈。

• 目的：以**线速**完成输入端口的处理

### 2.3 交换(转发)结构

#### 1 经内存交换（memory）

:yum:特点：交换由**CPU(选路处理器)控制完成**

:yum:过程：将分组拷贝到处理器**内存**中->**CPU**进行查找->将该分组拷贝到输出端口的**缓存**中

:yum:缺点：受**总线带宽**限制

<img src="Snipaste_2024-06-12_16-28-34.png" style="zoom:60%;" /> 

#### 2 经总线交换（bus）

:yum:特点： 输入端口通过一条**共享总线**将分组**直接传送**到输出端口，不需要选路处理器的干预
 **每次只能有一个分组通过总线传送**

:yum:缺点：受**总线速率**的限制

<img src="Snipaste_2024-06-12_16-32-30.png" style="zoom:140%;" /> 

#### 3 经互联网络交换（crossbar）

:yum:特点：纵横式(crossbar)交换机：由2n条总线组成，n个输入端口与n个输出端口连接。

:yum:过程：到达输入端口的分组**沿水平总线穿行**，**直至**与所**希望的**输出端口的垂直总线**交叉点**：若该条垂直总线空闲，则分组被传送到输出端口,否则在输入端排队

<img src="Snipaste_2024-06-12_16-36-16.png" style="zoom:60%;" /> 

### 2.4 何时出现排队

:one:输入端口排队

当**交换结构的速度**慢于**输入端口的速度**，就会在输入端口的缓冲区发生排队

:two:输出端口排队

从**交换结构到达输出端口的速率**超过**输出端口的传输速率**，则需要缓存数据报

:three:线头阻塞(HOL blocking)

在**队列前面的被阻塞**(输出端口竞争)的数据报会**阻止队列中的其他数据报被转发**。

### 2.5 分组调度(调度输出端口上排队的队列)

#### 1 FIFO

#### 2 优先级

同优先级时按FIFO

#### 3 Round Robin(两队列轮作)

同队列里按FIFO

## 3 网际协议：IPv4、寻址、IPv6

### 3.1 IP 数据报格式（IPv4）

<img src="Snipaste_2024-06-12_17-09-43.png" style="zoom:80%;" /> 

### 3.2 IPv4数据报分片和重组

MTU：数据**链路帧**的**数据区**的**最大字节数**（包含了网络层及以上头部）

**路由器**可能会将**数据报分片**成小的数据报 

<img src="Snipaste_2024-06-12_17-45-18.png" style="zoom:80%;" /> 4000 字节数据报， MTU = 1500 字节

:anger:例题

<img src="Snipaste_2024-06-12_18-07-13.png" style="zoom:60%;" /> **MTU**=数据报=**IP头+报文段**=IP头+TCP头+报文

### 3.3 IPv4编址

:yum:**IP**v4**地址**: 分配给**主机**或**路由器<u>*接口*</u>**(interface)的<u>32</u>-bit **标识符**

:yum:**一个接口对应一个IP地址**（主机和路由器都可以有多个接口）

:yum:IP地址由两部分**组成**：

 **网络号**：指明主机所在网络的编号。 **主机号**：主机在物理网络中的编号。

#### 1 早期：五类地址

<img src="Snipaste_2024-06-12_18-14-54.png" style="zoom:80%;" /> 

#### 2 **CIDR**技术（无类别域间路由选择）

 地址中的**网络部分可以任意长**
 地址格式: a.b.c.d/x, 这里 x 是地址网络部分的bit数

:yum:常用的特殊IP地址

 **127**.0.0.1/8-127.255.255.254/8 (127.0.0.0和127.255.255.255除外)**环回地址(localhost**:主机本身地址)
 169.254.0.0 /16 或 169.254.0.1 到 169.254.255.254  本地链路地址(自动专用IP地址)(在无可用 DHCP 服
务器时，使用它们进行自我配置)
 10.x.x.x, 172.16.x.x-172.31.x.x, **192.168**.x.x.   **私有的内网地址**
 0.0.0.0 来标识不清楚的网络和主机的
 **255**.255.255.255  **广播地址**(指一个网段内的所有主机)

#### 3 子网

IP地址具有同样的**网络部分**

**没有路由器的介入，物理上能够相互到达**(通过二层<u>交换机</u>)（<u>*故即使同一子网的两主机IP被错该，也能相互通信*</u>）

:yum:**定义**：为了确定子网，**分开<u>主机</u>和<u>路由器的每个接口</u>**，从而产生了几个分离的网络岛，这些独立网络中的每一个叫做一个子网（将路由器器去掉后的剩余每个区域）

<img src="Snipaste_2024-06-12_19-51-57.png" style="zoom:50%;" /> <img src="Snipaste_2024-06-12_19-52-06.png" style="zoom:60%;" /> 每片蓝色一个子网

**掩码**：网络号全1，主机号全0-------等同于声明**/24**之类的**网络前缀**----  255.255.255.0    =   /24

主机地址：一个主机的IP地址-----------------------------10.1.1.12/24

**网络号**（**网络地址**）：主机号全0的IP地址------------10.1.1.0/24

**广播地址**：主机号全1的IP地址---------------------------10.1.1.255/24

:yum:划分子网的**原因**:

形成<u>大型广播域</u>，导致：
 **网络**运行缓慢，原因是它导致的**流量太大**
 **设备**运行缓慢，原因是**设备**必须接受和处理**每个广播数据包**

:yum:子网的**划分**

从**ISP**那获得一个    **/24**   的的IP地址块，从地址的主机部分**借用若干位**来增加网络位**以划分子网**(位数越多可划分的子网就越多)，子网间用路由器隔开(路由器可以**隔绝广播域**)

:anger:例题：

<img src="Snipaste_2024-06-12_20-32-33.png" style="zoom:80%;" /> 

#### 4 IP寻址

因特网中IP寻址的概念；

:yum:属于**相同子网**的主机通信，可以直接发送分组（经交换机），**不需要路由器**参与；

:yum:属于**不同子网**的主机通信，发送主机首先将分组发送到它的**网关路由器**，由路由器帮助它**转发**分组到接收主机；

:yum:路由器是根据分组携带的目的IP地址的**网络号**(子网地址)，在转发表中**查找**其对应的输出端口，然后将分组转发到该网络号对应的输出端口输出。

#### 5 配置主机IP地址

为主机获取信息：IP地址、子网掩码、默认网关、DNS地址

##### (1)手动获取

##### (2)DHCP(动态主机配置协议获取)(使用**UDP**)

:yum:过程（C/S模型）（使用**UDP**）

 主机广播“DHCP **<u>discover</u>**” msg [optional]-----------C 请求一个IP地址

 DHCP服务器响应“DHCP **<u>offer</u>**” msg [optional]------S 给出一个IP地址

 主机请求IP地址：“DHCP **<u>request</u>**” msg---------------C 接受该IP地址后请求分配

 DHCP服务器发送地址: “DHCP **<u>ack</u>**” msg------------S 同意分配

:yum:DHCP返回的不仅仅是IP地址：（**IP地址**）
 客户的**第一跳路由器**的地址（**默认网关**）
 DNS服务器的IP地址和域名（**DNS地址**）
 网络掩码（**子网掩码**）

### 3.4 网络地址转换(NAT)

#### 1 IPv4地址枯竭问题

方案1：动态分配IP地址:当主机不连接因特网时，IP地址可被路由器**收回**重新分配给其他主机使用

方案2：**网络地址转换(NAT)**:划分出私有地址段，配置**私有IP地址的主机**不能直接访问外部网络(因特网)，**只能在自己的内部网络中使用**，因此可以在不同的内部网络中重复使用，内网主机如果需要**与外部网络通信**，可以**共用一个全局IP地址**来解决

#### 2 NAT：使用**内网**实现复用地址

:yum:执行NAT路由器应该完成的：

**外出的分组**: **替换**每个外出的分组的 (源IP 地址, 端口号) 为 (NAT IP 地址, 新端口号)

**进来的分组**: 对每个进来的分组，用保存在NAT表中的对应的(源IP 地址, 端口号) **替换**分组中的目的域 (NAT IP 地址, 新端口号）

 <img src="Snipaste_2024-06-12_21-28-21.png" style="zoom:70%;" />

:anger:例题：

<img src="Snipaste_2024-06-12_21-14-59.png" style="zoom:80%;" /> 

### 3.5 IPv6编址

IPv6数据报的格式: 

 固定长度的**40字节头部**（20+20）

 **不允许进行分片**

<img src="Snipaste_2024-06-12_20-51-51.png" style="zoom:60%;" /> 

## 4 SDN（软件定义网络）

传统网络的问题：难以实现网络流量优化，即根据流量动态调整转发表。

希望应用**软件可以参与对网络的控制管理**

# 第5章 网络层：控制平面

## 1 概述

有两种方法构建网络控制平台:

 在**每个路由器上控制**(传统方法)

 在**逻辑上集中地控制**(**SDN**)

## 2 路由选择算法

路由选择算法**决定转发表内容**。

:yum: 数据报服务：在给定源和目的地之间传输不同分组可能采用不同的路由。
 虚电路服务：在给定源和目的地之间的所有分组采用同一路径。

:yum:**默认路由器**(default gateway)：与主机直接相连的一台路由器，又叫**第一跳路由器**

:yum: **源路由器**：源主机的默认路由器。

 **目的路由器**：目的主机的默认路由器。

### 2.1 网络的抽象图模型

:one:图**G = (N，E)**表示N个节点和E条边的集合----结点u,v：路由器，边(u,v)：物理链接

:two:**c(x, y**)表示**边(x,y)的权值（费用）**

:three: 若节点x与节点y直接相连，则c(x, y) = 链路费用
 若节点x与节点y不直接相连，则c(x, y) = ∞

:four:路径：节点序列(x1 ,x2 ,…,xp )

### 2.2 路由算法分类

全局算法：用完整的、全局性的网络信息来计算最低费用路径

**分布式**算法：以**迭代的**、分布式的方式计算最低费用路径

静态算法：路由确定后基本不再变化，除非人为改变

动态算法：当网络的流量负载或拓扑发生变化时，改变路径

:yum:因特网常用的两种选路算法:

 动态全局链路状态算法 动态分布式距离向量算法

### 2.3 链路状态选路算法

前提条件：**已知**网络拓扑和**所有链路的费用**(由**链路状态<u>*广播算法*</u>**实现，最终使<u>所有节点都有</u>一个相同且<u>完整的网络视图</u>)

#### Dijkstra算法

Dijkstra算法是一种**迭代**算法，即经第**k次迭代**后，可知道到**k个目的节点的最低费用路径**。

:yum:基本思想：以源节点为起点，**每次找出一个**到源节点**费用最低的节点**，直到把所有目的节点都找到为止。

<img src="Snipaste_2024-06-12_21-59-53.png" style="zoom:80%;" /> 

:yum:算法的计算复杂性





### 2.4 距离向量选路算法DV



## 3 ISP域内路由选择：OSPF

## 4 ISP域间路由选择：BGP

## 5 SDN控制平面

## 6 ICMP协议

## 7 网络管理和SNMP

























# 第6章 链路层和局域网